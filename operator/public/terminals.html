<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terminals â€” Operator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='12' cy='16' r='7' fill='none' stroke='%236366f1' stroke-width='2.5'/%3E%3Ccircle cx='20' cy='16' r='7' fill='none' stroke='%23818cf8' stroke-width='2.5'/%3E%3C/svg%3E">
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-search@0.15.0/lib/addon-search.min.js"></script>
</head>
<body hx-boost="true">
  <div class="htmx-progress" id="progress-bar"></div>

  <nav class="nav">
    <a href="/" class="nav__brand">Operator <span class="ws-dot" id="ws-dot" title="WebSocket: connecting" aria-label="WebSocket status" role="status"></span></a>
    <ul class="nav__links">
      <li><a href="/" class="nav__link">Dashboard</a></li>
      <li><a href="/projects" class="nav__link">Projects</a></li>
      <li><a href="/analytics" class="nav__link">Analytics</a></li>
      <li><a href="/orchestrator" class="nav__link">Orchestrator</a></li>
      <li><a href="/terminals" class="nav__link nav__link--active">Terminals</a></li>
      <li><a href="/settings" class="nav__link">Settings</a></li>
    </ul>
    <select id="project-select" class="nav__project-select" onchange="onProjectChange(this.value)">
      <option value="">All Projects</option>
    </select>
  </nav>

  <main class="page terminals-page">
    <div class="page-header">
      <h1>Terminals</h1>
      <div class="page-header__actions">
        <button class="btn btn--sm btn--ghost" id="shortcuts-help" title="Keyboard Shortcuts" aria-label="Show keyboard shortcuts" onclick="toggleShortcutsHelp()">?</button>
        <button class="btn btn--sm btn--ghost" id="view-toggle" onclick="toggleTerminalView()" title="Toggle grid/tab view (Ctrl+Shift+G)" aria-label="Toggle grid/tab view">
          <span id="view-toggle-icon">&#9638;&#9638;</span>
        </button>
        <button class="btn btn--sm btn--primary" id="add-instance-btn" onclick="addInstance()" title="Add orchestrator instance (Ctrl+N)" aria-label="Add instance">+ New Instance</button>
      </div>
    </div>

    <!-- Worker Health Panel (collapsible) -->
    <details class="term-health" id="term-health">
      <summary class="term-health__toggle">
        <span class="term-health__title">Worker Health</span>
        <span class="term-health__badge" id="health-badge" title="Total workers">0</span>
      </summary>
      <div class="term-health__grid" id="health-grid">
        <!-- Health cards rendered dynamically by terminals.js -->
        <div class="term-health__empty" id="health-empty">No workers in pool</div>
      </div>
    </details>

    <!-- Tab Bar -->
    <div class="term-tabs" id="term-tabs" role="tablist" aria-label="Orchestrator instances">
      <!-- Tabs rendered dynamically by terminals.js -->
    </div>

    <!-- Terminal Panels Container -->
    <div class="term-panels" id="term-panels">
      <!-- Terminal panels rendered dynamically by terminals.js -->
      <div class="term-empty" id="term-empty">
        <p>No orchestrator instances running.</p>
        <p>Click <strong>+ New Instance</strong> to start one, or go to the <a href="/orchestrator">Orchestrator</a> page to launch a mission.</p>
      </div>
    </div>

    <!-- New Instance Dialog -->
    <dialog class="term-dialog" id="new-instance-dialog">
      <article>
        <header>
          <button class="btn btn--sm btn--ghost" onclick="document.getElementById('new-instance-dialog').close()" aria-label="Close" style="float:right">&times;</button>
          <h3>New Orchestrator Instance</h3>
        </header>
        <form id="new-instance-form" onsubmit="return submitNewInstance(event)">
          <label>
            Instance ID
            <input type="text" name="instanceId" placeholder="e.g. worker-1" required pattern="[a-zA-Z0-9_-]+" title="Letters, numbers, hyphens, underscores">
          </label>
          <label>
            Mission
            <select name="mission" id="instance-mission-select">
              <option value="">Loading missions...</option>
            </select>
          </label>
          <label>
            Model
            <select name="model">
              <option value="sonnet">Sonnet</option>
              <option value="opus">Opus</option>
              <option value="haiku">Haiku</option>
            </select>
          </label>
          <label>
            <input type="checkbox" name="dryRun" style="width:auto;margin-right:var(--sp-1)">
            Dry Run
          </label>
          <footer>
            <button type="button" class="btn btn--ghost" onclick="document.getElementById('new-instance-dialog').close()">Cancel</button>
            <button type="submit" class="btn btn--primary">Start Instance</button>
          </footer>
        </form>
      </article>
    </dialog>
  </main>

  <!-- Instance Config Dialog -->
  <dialog class="term-dialog config-dialog" id="config-dialog">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('config-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Configure Instance: <span id="config-dialog-id"></span></h3>
      </header>
      <form id="config-form" onsubmit="return submitConfig(event)">
        <input type="hidden" name="instanceId" id="config-instance-id">
        <label>
          Model
          <select name="model" id="config-model">
            <option value="haiku">Haiku</option>
            <option value="sonnet" selected>Sonnet</option>
            <option value="opus">Opus</option>
          </select>
        </label>
        <label>
          Max Budget (USD)
          <input type="number" name="maxBudgetUsd" id="config-budget" min="0" max="100" step="0.5" value="5" placeholder="e.g. 5.00">
        </label>
        <label>
          Max Turns
          <input type="number" name="maxTurns" id="config-turns" min="1" max="200" step="1" value="30" placeholder="e.g. 30">
        </label>
        <footer>
          <button type="button" class="btn btn--ghost" onclick="document.getElementById('config-dialog').close()">Cancel</button>
          <button type="submit" class="btn btn--primary">Apply</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Keyboard Shortcuts Help -->
  <dialog class="term-dialog shortcuts-dialog" id="shortcuts-dialog">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('shortcuts-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Keyboard Shortcuts</h3>
      </header>
      <div class="shortcuts-grid">
        <kbd>Ctrl+1-4</kbd><span>Switch to terminal 1-4</span>
        <kbd>Ctrl+Shift+&larr;/&rarr;</kbd><span>Previous / next terminal</span>
        <kbd>Ctrl+N</kbd><span>New instance</span>
        <kbd>Ctrl+W</kbd><span>Close active terminal</span>
        <kbd>Ctrl+H</kbd><span>Handoff active terminal</span>
        <kbd>Ctrl+F</kbd><span>Search in terminal</span>
        <kbd>Ctrl+Shift+G</kbd><span>Toggle grid / tab view</span>
        <kbd>Ctrl+Shift+M</kbd><span>Maximize / restore panel</span>
        <kbd>Escape</kbd><span>Close dialog / search</span>
      </div>
    </article>
  </dialog>

  <div id="toast-container"></div>
  <script src="/app.js"></script>
  <script src="/terminals.js"></script>
</body>
</html>
