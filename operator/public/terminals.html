<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Terminals â€” Operator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32' fill='none'%3E%3Cpath d='M16 5L4 12l12 6 12-6L16 5z' stroke='%236366f1' stroke-width='2' stroke-linejoin='round'/%3E%3Cpath d='M4 16l12 6 12-6' stroke='%23818cf8' stroke-width='2' stroke-linejoin='round'/%3E%3Cpath d='M4 21l12 6 12-6' stroke='%2322d3ee' stroke-width='2' stroke-linejoin='round'/%3E%3C/svg%3E">
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/css/xterm.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@xterm/xterm@5.5.0/lib/xterm.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-search@0.15.0/lib/addon-search.min.js"></script>
</head>
<body class="has-sidebar" hx-boost="true">
  <div class="htmx-progress" id="progress-bar"></div>

  <aside class="sidebar-nav" id="sidebar-nav">
    <a href="/" class="sidebar-nav__brand">
      <span class="sidebar-nav__brand-icon"><svg viewBox="0 0 32 32" fill="none"><path d="M16 5L4 12l12 6 12-6L16 5z" stroke="#6366f1" stroke-width="2" stroke-linejoin="round"/><path d="M4 16l12 6 12-6" stroke="#818cf8" stroke-width="2" stroke-linejoin="round"/><path d="M4 21l12 6 12-6" stroke="#22d3ee" stroke-width="2" stroke-linejoin="round"/></svg></span>
      <span class="sidebar-nav__brand-text">Operator</span>
    </a>
    <ul class="sidebar-nav__links">
      <li><a href="/dashboard" class="sidebar-nav__link" data-page="/dashboard">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="6" height="6" rx="1"/><rect x="11" y="3" width="6" height="6" rx="1"/><rect x="3" y="11" width="6" height="6" rx="1"/><rect x="11" y="11" width="6" height="6" rx="1"/></svg></span>
        <span class="sidebar-nav__label">Dashboard</span>
      </a></li>
      <li><a href="/console" hx-boost="false" class="sidebar-nav__link" data-page="/console">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="16" height="14" rx="2"/><path d="M5 8l3 2.5L5 13"/><line x1="10" y1="13" x2="15" y2="13"/><circle cx="15" cy="8" r="1.5"/></svg></span>
        <span class="sidebar-nav__label">Console</span>
      </a></li>
      <li><a href="/terminals" hx-boost="false" class="sidebar-nav__link sidebar-nav__link--active" data-page="/terminals">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="14" height="14" rx="2"/><path d="M6 8l3 2.5L6 13"/><line x1="11" y1="13" x2="14" y2="13"/></svg></span>
        <span class="sidebar-nav__label">Terminals</span>
      </a></li>
      <li><a href="/taskboard" class="sidebar-nav__link" data-page="/taskboard">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 4h8a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2z"/><path d="M7 8h6M7 11h4"/></svg></span>
        <span class="sidebar-nav__label">Tasks</span>
      </a></li>
      <li><a href="/timeline" class="sidebar-nav__link" data-page="/timeline">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M10 3v14"/><circle cx="10" cy="6" r="2"/><circle cx="10" cy="11" r="2"/><circle cx="10" cy="16" r="1.5"/></svg></span>
        <span class="sidebar-nav__label">Timeline</span>
      </a></li>
      <li><a href="/projects" class="sidebar-nav__link" data-page="/projects">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 5.5A1.5 1.5 0 014.5 4h3.172a1.5 1.5 0 011.06.44L10 5.706a1.5 1.5 0 001.06.44H15.5A1.5 1.5 0 0117 7.646V14.5a1.5 1.5 0 01-1.5 1.5h-11A1.5 1.5 0 013 14.5V5.5z"/></svg></span>
        <span class="sidebar-nav__label">Projects</span>
      </a></li>
      <li><a href="/settings" class="sidebar-nav__link" data-page="/settings">
        <span class="sidebar-nav__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="2.5"/><path d="M10 2.5v2M10 15.5v2M2.5 10h2M15.5 10h2M4.4 4.4l1.4 1.4M14.2 14.2l1.4 1.4M4.4 15.6l1.4-1.4M14.2 5.8l1.4-1.4"/></svg></span>
        <span class="sidebar-nav__label">Settings</span>
      </a></li>
    </ul>
    <div class="sidebar-nav__footer">
      <span class="sidebar-nav__ws-dot" id="ws-dot" title="WebSocket: connecting" aria-label="WebSocket status" role="status"></span>
      <span class="sidebar-nav__ws-label">WebSocket</span>
    </div>
    <div class="sidebar-nav__footer"><select id="project-select" class="sidebar-nav__project" onchange="onProjectChange(this.value)"><option value="">All Projects</option></select></div>
  </aside>

  <main class="page terminals-page" data-page-id="terminals">
    <div class="page-header">
      <h1>Terminals <span class="badge badge--neutral" id="terminal-count-badge" style="display:none;font-size:0.75rem;vertical-align:middle"></span></h1>
      <div class="page-header__actions">
        <button class="btn btn--sm btn--ghost" id="shortcuts-help" title="Keyboard Shortcuts" aria-label="Show keyboard shortcuts" onclick="toggleShortcutsHelp()">?</button>
        <div class="layout-selector" id="layout-selector" title="Panel layout">
          <button class="layout-selector__btn" data-layout="single" onclick="setLayout('single')" title="Single panel" aria-label="Single panel layout">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="12" height="12" rx="1"/></svg>
          </button>
          <button class="layout-selector__btn" data-layout="split-h" onclick="setLayout('split-h')" title="Side by side" aria-label="Split horizontal layout">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="5" height="12" rx="1"/><rect x="9" y="2" width="5" height="12" rx="1"/></svg>
          </button>
          <button class="layout-selector__btn" data-layout="split-v" onclick="setLayout('split-v')" title="Stacked" aria-label="Split vertical layout">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="12" height="5" rx="1"/><rect x="2" y="9" width="12" height="5" rx="1"/></svg>
          </button>
          <button class="layout-selector__btn" data-layout="triple" onclick="setLayout('triple')" title="1 + 2 split" aria-label="Triple panel layout">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="5" height="12" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg>
          </button>
          <button class="layout-selector__btn" data-layout="quad" onclick="setLayout('quad')" title="2x2 grid" aria-label="Quad panel layout">
            <svg viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="2" width="5" height="5" rx="1"/><rect x="9" y="2" width="5" height="5" rx="1"/><rect x="2" y="9" width="5" height="5" rx="1"/><rect x="9" y="9" width="5" height="5" rx="1"/></svg>
          </button>
        </div>
        <button class="btn btn--sm btn--ghost" id="view-toggle" onclick="toggleTerminalView()" title="Toggle grid/tab view (Ctrl+Shift+G)" aria-label="Toggle grid/tab view">
          <span id="view-toggle-icon">&#9638;&#9638;</span>
        </button>
        <button class="btn btn--sm btn--ghost" id="messages-toggle" onclick="toggleMessagePanel()" title="Terminal Messages (Ctrl+Shift+I)" aria-label="Toggle terminal messages panel" style="position:relative">&#9993;<span class="msg-unread-badge" id="msg-unread-badge" style="display:none"></span></button>
        <button class="btn btn--sm btn--ghost" id="sessions-toggle" onclick="toggleSessionHistory()" title="Session History" aria-label="Toggle session history panel">&#128196;</button>
        <button class="btn btn--sm btn--ghost" id="memory-toggle" onclick="toggleMemoryPanel()" title="Shared Memory (Ctrl+M)" aria-label="Toggle shared memory panel">&#128200;</button>
        <button class="btn btn--sm btn--ghost" id="sidebar-toggle" onclick="toggleSidebar()" title="Toggle file sidebar (Ctrl+B)" aria-label="Toggle file sidebar">&#128193;</button>
        <button class="btn btn--sm btn--primary" id="add-terminal-btn" onclick="openNewTerminal()" title="New terminal" aria-label="New terminal">+ New</button>
      </div>
    </div>

    <!-- Pool Status Bar -->
    <div class="pool-status-bar" id="pool-status-bar" style="display:none">
      <span class="pool-status__item" id="pool-running" title="Running terminals">0 running</span>
      <span class="pool-status__sep">|</span>
      <span class="pool-status__item pool-status__active" id="pool-active" title="Active (producing output)">0 active</span>
      <span class="pool-status__item pool-status__idle" id="pool-idle" title="Idle (no output >10s)">0 idle</span>
      <span class="pool-status__item pool-status__waiting" id="pool-waiting" title="Waiting (has task, idle)">0 waiting</span>
      <span class="pool-status__sep">|</span>
      <span class="pool-status__item" id="pool-tasks" title="Terminals with assigned tasks">0 tasks</span>
      <span class="pool-status__item" id="pool-dispatch" title="Auto-dispatch enabled">0 auto-dispatch</span>
      <span class="pool-status__item" id="pool-complete" title="Auto-complete enabled">0 auto-complete</span>
    </div>

    <!-- Swarm Control Bar (Phase 24+25) -->
    <div class="swarm-bar" id="swarm-bar" style="display:none">
      <span class="swarm-dot" id="swarm-dot"></span>
      <span id="swarm-label">Swarm: Off</span>
      <span class="pool-status__sep">|</span>
      <span id="swarm-terminals">0/0 terminals</span>
      <span id="swarm-pending">0 pending</span>
      <span class="swarm-stat swarm-stat--success" id="swarm-completed" style="display:none">0 done</span>
      <span class="swarm-stat swarm-stat--error" id="swarm-failed" style="display:none">0 failed</span>
      <span class="swarm-stat swarm-stat--warning" id="swarm-recovered" style="display:none">0 recovered</span>
      <span class="swarm-stat" id="swarm-throughput" style="display:none">0 tasks/hr</span>
      <div class="swarm-progress" id="swarm-progress" style="display:none">
        <div class="swarm-progress__bar" id="swarm-progress-bar"></div>
      </div>
      <button class="btn btn--sm btn--primary" id="swarm-start-btn" onclick="openSwarmConfig()">Start Swarm</button>
      <button class="btn btn--sm btn--danger" id="swarm-stop-btn" style="display:none" onclick="stopSwarm()">Stop Swarm</button>
    </div>

    <!-- Tab Bar -->
    <div class="term-tabs" id="term-tabs" role="tablist" aria-label="Orchestrator instances">
      <!-- Tabs rendered dynamically by terminals.js -->
    </div>

    <!-- Workspace: Sidebar + Terminal Panels -->
    <div class="term-workspace" id="term-workspace">
      <!-- File Sidebar (collapsible) -->
      <aside class="term-sidebar term-sidebar--hidden" id="term-sidebar">
        <div class="term-sidebar__header">
          <span class="term-sidebar__title">Files</span>
          <button class="btn btn--xs btn--ghost term-sidebar__refresh" onclick="refreshSidebarTree()" title="Refresh" aria-label="Refresh file tree">&#8635;</button>
          <button class="btn btn--xs btn--ghost term-sidebar__close" onclick="toggleSidebar()" title="Close sidebar" aria-label="Close sidebar">&times;</button>
        </div>
        <input type="search" class="term-sidebar__search" placeholder="Filter files..." oninput="filterSidebarTree(this)" autocomplete="off" aria-label="Filter files">
        <div class="term-sidebar__tree project-tree" id="sidebar-tree" data-root="">
          <div class="tree-empty">Select a Claude terminal to browse its project files.</div>
        </div>
      </aside>
      <!-- Terminal Panels Container -->
      <div class="term-panels" id="term-panels">
        <!-- Terminal panels rendered dynamically by terminals.js -->
        <div class="term-empty" id="term-empty">
          <p>No terminals running.</p>
          <p>Click <strong>+ New</strong> to start a terminal session.</p>
        </div>
      </div>
    </div>

    <!-- Terminal Type Chooser -->
    <dialog class="term-dialog" id="new-terminal-chooser">
      <article>
        <header>
          <button class="btn btn--sm btn--ghost" onclick="document.getElementById('new-terminal-chooser').close()" aria-label="Close" style="float:right">&times;</button>
          <h3>New Terminal</h3>
        </header>
        <div class="chooser-cards">
          <button class="chooser-card" onclick="document.getElementById('new-terminal-chooser').close(); addClaudeTerminal()">
            <span class="chooser-card__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="14" height="14" rx="2"/><path d="M6 8l3 2.5L6 13"/><line x1="11" y1="13" x2="14" y2="13"/></svg></span>
            <span class="chooser-card__title">Interactive Session</span>
            <span class="chooser-card__desc">Chat with Claude directly. Type prompts, get responses. Like having Claude Code in your browser.</span>
          </button>
          <button class="chooser-card" onclick="document.getElementById('new-terminal-chooser').close(); addInstance()">
            <span class="chooser-card__icon"><svg viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="10" cy="10" r="3"/><path d="M10 3v2m0 10v2M3 10h2m10 0h2m-1.5-5.5L14 6m-8 8l-1.5 1.5m0-11L6 6m8 8l1.5 1.5"/></svg></span>
            <span class="chooser-card__title">Automated Worker</span>
            <span class="chooser-card__desc">Runs missions and tasks automatically. Output-only &mdash; you watch it work.</span>
          </button>
        </div>
      </article>
    </dialog>

    <!-- New Instance Dialog -->
    <dialog class="term-dialog" id="new-instance-dialog">
      <article>
        <header>
          <button class="btn btn--sm btn--ghost" onclick="document.getElementById('new-instance-dialog').close()" aria-label="Close" style="float:right">&times;</button>
          <h3>New Orchestrator Instance</h3>
        </header>
        <form id="new-instance-form" onsubmit="return submitNewInstance(event)">
          <label>
            Instance ID
            <input type="text" name="instanceId" placeholder="e.g. worker-1" required pattern="[a-zA-Z0-9_-]+" title="Letters, numbers, hyphens, underscores">
          </label>
          <label>
            Mission
            <select name="mission" id="instance-mission-select">
              <option value="">Loading missions...</option>
            </select>
          </label>
          <label>
            Model
            <select name="model">
              <option value="opus" selected>Opus</option>
              <option value="sonnet">Sonnet</option>
              <option value="haiku">Haiku</option>
            </select>
          </label>
          <label>
            <input type="checkbox" name="dryRun" style="width:auto;margin-right:var(--sp-1)">
            Dry Run
          </label>
          <footer>
            <button type="button" class="btn btn--ghost" onclick="document.getElementById('new-instance-dialog').close()">Cancel</button>
            <button type="submit" class="btn btn--primary">Start Instance</button>
          </footer>
        </form>
      </article>
    </dialog>
    <!-- New Claude Terminal Dialog -->
    <dialog class="term-dialog" id="new-claude-dialog">
      <article>
        <header>
          <button class="btn btn--sm btn--ghost" onclick="document.getElementById('new-claude-dialog').close()" aria-label="Close" style="float:right">&times;</button>
          <h3>New Claude Terminal</h3>
        </header>
        <form id="new-claude-form" onsubmit="return submitNewClaude(event)">
          <label>
            Template <small>(optional, pre-fills config)</small>
            <select name="template" onchange="applyClaudeTemplate(this)">
              <option value="">Custom / No template</option>
            </select>
          </label>
          <label>
            Terminal ID
            <input type="text" name="terminalId" placeholder="e.g. claude-1" required pattern="[a-zA-Z0-9_-]+" title="Letters, numbers, hyphens, underscores">
          </label>
          <label>
            Project Directory <small>(optional, defaults to server project)</small>
            <input type="text" name="projectDir" placeholder="/path/to/project" autocomplete="off">
          </label>
          <label>
            Model
            <select name="model">
              <option value="opus" selected>Opus</option>
              <option value="sonnet">Sonnet</option>
              <option value="haiku">Haiku</option>
            </select>
          </label>
          <label>
            <input type="checkbox" name="dangerouslySkipPermissions">
            Skip Permissions
          </label>
          <label>
            <input type="checkbox" name="autoHandoff" checked>
            Auto-Handoff <small>(auto-continue on context exhaustion)</small>
          </label>
          <label>
            <input type="checkbox" name="autoDispatch">
            Auto-Dispatch <small>(auto-claim next task on completion)</small>
          </label>
          <label>
            <input type="checkbox" name="autoComplete">
            Auto-Complete <small>(detect task completion from idle state)</small>
          </label>
          <footer>
            <button type="button" class="btn btn--ghost" onclick="document.getElementById('new-claude-dialog').close()">Cancel</button>
            <button type="submit" class="btn btn--primary">Start Terminal</button>
          </footer>
        </form>
      </article>
    </dialog>
  </main>

  <!-- Instance Config Dialog -->
  <dialog class="term-dialog config-dialog" id="config-dialog">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('config-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Configure Instance: <span id="config-dialog-id"></span></h3>
      </header>
      <form id="config-form" onsubmit="return submitConfig(event)">
        <input type="hidden" name="instanceId" id="config-instance-id">
        <label>
          Model
          <select name="model" id="config-model">
            <option value="haiku">Haiku</option>
            <option value="sonnet" selected>Sonnet</option>
            <option value="opus">Opus</option>
          </select>
        </label>
        <label>
          Max Budget (USD)
          <input type="number" name="maxBudgetUsd" id="config-budget" min="0" max="100" step="0.5" value="5" placeholder="e.g. 5.00">
        </label>
        <label>
          Max Turns
          <input type="number" name="maxTurns" id="config-turns" min="1" max="200" step="1" value="30" placeholder="e.g. 30">
        </label>
        <footer>
          <button type="button" class="btn btn--ghost" onclick="document.getElementById('config-dialog').close()">Cancel</button>
          <button type="submit" class="btn btn--primary">Apply</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Terminal Messages Panel (Phase 18) -->
  <dialog class="term-dialog messages-dialog" id="messages-dialog" style="max-width:780px;max-height:80vh">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('messages-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Terminal Messages</h3>
      </header>
      <div class="messages-panel">
        <!-- Compose Form -->
        <details open>
          <summary style="cursor:pointer;font-weight:600;margin-bottom:var(--sp-2)">Compose</summary>
          <div style="display:flex;gap:var(--sp-2);margin-bottom:var(--sp-2);flex-wrap:wrap">
            <select id="msg-from" style="flex:1;min-width:120px" aria-label="From terminal">
              <option value="">From...</option>
            </select>
            <select id="msg-to" style="flex:1;min-width:120px" aria-label="To terminal">
              <option value="">Broadcast (all)</option>
            </select>
            <select id="msg-category" style="flex:0 0 120px" aria-label="Category">
              <option value="general">general</option>
              <option value="status">status</option>
              <option value="question">question</option>
              <option value="finding">finding</option>
              <option value="request">request</option>
            </select>
          </div>
          <div style="display:flex;gap:var(--sp-2)">
            <textarea id="msg-content" placeholder="Message content..." rows="2" style="flex:1;resize:vertical" aria-label="Message content"></textarea>
            <button class="btn btn--sm btn--primary" onclick="sendTerminalMessage()" style="align-self:flex-end">Send</button>
          </div>
        </details>
        <!-- Message List -->
        <div style="margin-top:var(--sp-3)">
          <div style="display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-2)">
            <strong>Messages</strong>
            <span class="badge badge--neutral" id="msg-count">0</span>
          </div>
          <div id="msg-list" class="msg-list" style="max-height:320px;overflow-y:auto">
            <p class="text-muted">No messages yet.</p>
          </div>
        </div>
        <!-- Thread View (hidden by default) -->
        <div id="msg-thread-view" style="display:none;margin-top:var(--sp-3)">
          <div style="display:flex;align-items:center;gap:var(--sp-2);margin-bottom:var(--sp-2)">
            <button class="btn btn--xs btn--ghost" onclick="closeThreadView()" aria-label="Back to messages">&larr; Back</button>
            <strong>Thread</strong>
          </div>
          <div id="msg-thread-list" style="max-height:240px;overflow-y:auto"></div>
          <div style="display:flex;gap:var(--sp-2);margin-top:var(--sp-2)">
            <input type="hidden" id="msg-thread-root">
            <input type="text" id="msg-thread-reply" placeholder="Reply..." style="flex:1" autocomplete="off" aria-label="Thread reply">
            <button class="btn btn--sm btn--primary" onclick="sendThreadReply()">Reply</button>
          </div>
        </div>
      </div>
      <footer style="display:flex;justify-content:space-between;margin-top:var(--sp-3)">
        <button class="btn btn--sm btn--ghost" onclick="refreshMessagePanel()">Refresh</button>
        <button class="btn btn--sm btn--ghost" style="color:var(--clr-error)" onclick="clearAllMessages()">Clear All</button>
      </footer>
    </article>
  </dialog>

  <!-- Shared Memory Panel -->
  <dialog class="term-dialog memory-dialog" id="memory-dialog" style="max-width:720px;max-height:80vh">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('memory-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Shared Memory</h3>
      </header>
      <div class="memory-panel">
        <!-- Add Key Form -->
        <div class="memory-add" style="display:flex;gap:var(--sp-2);margin-bottom:var(--sp-3)">
          <input type="text" id="memory-new-key" placeholder="key (e.g. project:plan)" style="flex:1" autocomplete="off">
          <input type="text" id="memory-new-value" placeholder="value" style="flex:2" autocomplete="off">
          <button class="btn btn--sm btn--primary" onclick="addMemoryKey()">Add</button>
        </div>
        <!-- Key-Value Store -->
        <details open>
          <summary style="cursor:pointer;font-weight:600;margin-bottom:var(--sp-2)">Shared Keys <span class="badge badge--neutral" id="memory-key-count">0</span></summary>
          <div id="memory-entries" class="memory-entries" style="max-height:240px;overflow-y:auto">
            <p class="text-muted">No keys stored yet.</p>
          </div>
        </details>
        <!-- Terminal Snapshots -->
        <details style="margin-top:var(--sp-3)">
          <summary style="cursor:pointer;font-weight:600;margin-bottom:var(--sp-2)">Terminal Snapshots <span class="badge badge--neutral" id="memory-snapshot-count">0</span></summary>
          <div id="memory-snapshots" class="memory-snapshots" style="max-height:240px;overflow-y:auto">
            <p class="text-muted">No snapshots yet.</p>
          </div>
        </details>
      </div>
      <footer style="display:flex;justify-content:space-between;margin-top:var(--sp-3)">
        <button class="btn btn--sm btn--ghost" onclick="refreshMemoryPanel()">Refresh</button>
        <button class="btn btn--sm btn--ghost" style="color:var(--clr-error)" onclick="clearAllMemory()">Clear All</button>
      </footer>
    </article>
  </dialog>

  <!-- Task Completion Dialog -->
  <dialog class="term-dialog" id="task-complete-dialog" style="max-width:420px">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('task-complete-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3 id="task-complete-title">Complete Task</h3>
      </header>
      <form id="task-complete-form" onsubmit="return submitTaskComplete(event)">
        <input type="hidden" name="terminalId" id="task-complete-terminal-id">
        <input type="hidden" name="status" id="task-complete-status">
        <label id="task-complete-result-label">
          Result summary <small>(optional)</small>
          <input type="text" name="result" id="task-complete-result" placeholder="Brief summary of what was done" autocomplete="off">
        </label>
        <label id="task-complete-error-label" style="display:none">
          Error reason <small>(optional)</small>
          <input type="text" name="error" id="task-complete-error" placeholder="What went wrong" autocomplete="off">
        </label>
        <footer>
          <button type="button" class="btn btn--ghost" onclick="document.getElementById('task-complete-dialog').close()">Cancel</button>
          <button type="submit" class="btn btn--primary" id="task-complete-submit">Complete</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Swarm Config Dialog (Phase 24) -->
  <dialog class="term-dialog" id="swarm-config-dialog" style="max-width:480px">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('swarm-config-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Start Swarm</h3>
      </header>
      <form id="swarm-config-form" onsubmit="return submitSwarmConfig(event)">
        <label>
          Min Terminals <small>(initial seed)</small>
          <input type="number" name="minTerminals" value="2" min="1" max="8" step="1">
        </label>
        <label>
          Max Terminals <small>(scale ceiling)</small>
          <input type="number" name="maxTerminals" value="8" min="1" max="32" step="1">
        </label>
        <label>
          Model
          <select name="model">
            <option value="sonnet" selected>Sonnet</option>
            <option value="haiku">Haiku</option>
            <option value="opus">Opus</option>
          </select>
        </label>
        <label>
          Scale-up Threshold <small>(pending tasks per terminal)</small>
          <input type="number" name="scaleUpThreshold" value="2" min="1" max="10" step="1">
        </label>
        <label>
          System Prompt <small>(optional, appended to each terminal)</small>
          <textarea name="systemPrompt" rows="2" placeholder="Additional instructions for swarm terminals..." style="resize:vertical"></textarea>
        </label>
        <label>
          <input type="checkbox" name="dangerouslySkipPermissions" checked>
          Skip Permissions
        </label>
        <footer>
          <button type="button" class="btn btn--ghost" onclick="document.getElementById('swarm-config-dialog').close()">Cancel</button>
          <button type="submit" class="btn btn--primary">Start Swarm</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Session History Dialog (Phase 48) -->
  <dialog class="term-dialog" id="sessions-dialog" style="max-width:700px">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('sessions-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Session History</h3>
      </header>
      <div style="display:flex;gap:0.5rem;margin-bottom:0.75rem;align-items:center">
        <select id="sessions-filter" onchange="refreshSessionsList()" style="max-width:140px">
          <option value="all">All</option>
          <option value="completed">Completed</option>
          <option value="running">Running</option>
        </select>
        <span id="sessions-count" style="color:var(--text-muted,#888);font-size:0.85em"></span>
      </div>
      <div id="sessions-list" style="max-height:400px;overflow-y:auto"></div>
    </article>
  </dialog>

  <!-- Save Template Dialog (Phase 48) -->
  <dialog class="term-dialog" id="save-template-dialog">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('save-template-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Save as Template</h3>
      </header>
      <form id="save-template-form" onsubmit="return submitSaveTemplate(event)">
        <input type="hidden" name="terminalId" id="save-template-terminal-id">
        <label>
          Template Name
          <input type="text" name="name" placeholder="e.g. my-workflow" required pattern="[a-zA-Z0-9_-]+" title="Letters, numbers, hyphens, underscores">
        </label>
        <footer>
          <button type="button" class="btn btn--ghost" onclick="document.getElementById('save-template-dialog').close()">Cancel</button>
          <button type="submit" class="btn btn--primary">Save Template</button>
        </footer>
      </form>
    </article>
  </dialog>

  <!-- Keyboard Shortcuts Help -->
  <dialog class="term-dialog shortcuts-dialog" id="shortcuts-dialog">
    <article>
      <header>
        <button class="btn btn--sm btn--ghost" onclick="document.getElementById('shortcuts-dialog').close()" aria-label="Close" style="float:right">&times;</button>
        <h3>Keyboard Shortcuts</h3>
      </header>
      <div class="shortcuts-grid">
        <kbd>Ctrl+1-4</kbd><span>Switch to terminal 1-4</span>
        <kbd>Ctrl+Shift+&larr;/&rarr;</kbd><span>Previous / next terminal</span>
        <kbd>Ctrl+Shift+C</kbd><span>New interactive session</span>
        <kbd>Ctrl+N</kbd><span>New automated worker</span>
        <kbd>Ctrl+W</kbd><span>Close active terminal</span>
        <kbd>Ctrl+H</kbd><span>Handoff active terminal</span>
        <kbd>Ctrl+F</kbd><span>Search in terminal</span>
        <kbd>Ctrl+Shift+G</kbd><span>Toggle grid / tab view</span>
        <kbd>Ctrl+Shift+M</kbd><span>Maximize / restore panel</span>
        <kbd>Ctrl+B</kbd><span>Toggle file sidebar</span>
        <kbd>Ctrl+Shift+A</kbd><span>Toggle auto-handoff</span>
        <kbd>Ctrl+Shift+D</kbd><span>Toggle auto-dispatch</span>
        <kbd>Ctrl+Shift+E</kbd><span>Toggle auto-complete</span>
        <kbd>Ctrl+Shift+S</kbd><span>Toggle swarm mode</span>
        <kbd>Ctrl+M</kbd><span>Shared memory panel</span>
        <kbd>Ctrl+Shift+I</kbd><span>Terminal messages panel</span>
        <kbd>1-5</kbd><span>Layout: single / split-h / split-v / triple / quad</span>
        <kbd>Escape</kbd><span>Close dialog / search</span>
      </div>
    </article>
  </dialog>

  <div id="toast-container"></div>
  <script src="/app.js"></script>
  <script src="/terminals.js"></script>
</body>
</html>
