<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Orchestrator — Operator</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <link rel="stylesheet" href="/style.css">
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'%3E%3Ccircle cx='12' cy='16' r='7' fill='none' stroke='%236366f1' stroke-width='2.5'/%3E%3Ccircle cx='20' cy='16' r='7' fill='none' stroke='%23818cf8' stroke-width='2.5'/%3E%3C/svg%3E">
  <script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body hx-boost="true">
  <div class="htmx-progress" id="progress-bar"></div>

  <nav class="nav">
    <a href="/" class="nav__brand">Operator <span class="ws-dot" id="ws-dot" title="WebSocket: connecting"></span></a>
    <ul class="nav__links">
      <li><a href="/" class="nav__link">Dashboard</a></li>
      <li><a href="/orchestrator" class="nav__link nav__link--active">Orchestrator</a></li>
      <li><a href="/settings" class="nav__link">Settings</a></li>
    </ul>
    <select id="project-select" class="nav__project-select" onchange="onProjectChange(this.value)">
      <option value="">All Projects</option>
    </select>
  </nav>

  <main class="page">
    <div class="page-header">
      <h1>Orchestrator</h1>
    </div>

    <!-- Mission Launcher -->
    <div class="section">
      <p class="section__title">Launch Mission</p>
      <div id="mission-launcher"
           hx-get="/views/mission-launcher"
           hx-trigger="load, reload from:#mission-launcher"
           hx-swap="innerHTML">
        <div class="skeleton" style="height:60px"></div>
      </div>
    </div>

    <!-- Status -->
    <div class="section">
      <p class="section__title">Status</p>
      <div id="orch-content"
           hx-get="/views/orch-status"
           hx-trigger="load, every 3s, reload from:#orch-content"
           hx-swap="innerHTML">
        <div class="skeleton" style="height:32px;width:240px;margin-bottom:16px"></div>
        <div class="skeleton" style="height:16px;width:60%;margin-bottom:24px"></div>
        <div class="agent-grid">
          <div class="agent-card"><div class="skeleton" style="height:60px"></div></div>
          <div class="agent-card"><div class="skeleton" style="height:60px"></div></div>
          <div class="agent-card"><div class="skeleton" style="height:60px"></div></div>
        </div>
      </div>
    </div>

    <!-- Live Log -->
    <div class="section">
      <p class="section__title">
        Live Log
        <button class="btn btn--sm btn--ghost" onclick="clearLog()" style="margin-left:var(--sp-3)">Clear</button>
        <label style="margin-left:var(--sp-3);font-size:0.75rem;font-weight:400;text-transform:none;letter-spacing:0;color:var(--text-secondary)">
          <input type="checkbox" id="log-autoscroll" checked style="width:auto;margin-right:var(--sp-1)">
          Auto-scroll
        </label>
      </p>
      <div id="log-panel" class="log-panel">
        <div class="log-panel__empty">Waiting for orchestrator output...</div>
      </div>
    </div>

    <!-- Reports -->
    <div class="section">
      <p class="section__title">Reports</p>
      <div id="report-viewer"
           hx-get="/views/report-viewer"
           hx-trigger="load, every 15s"
           hx-swap="innerHTML">
        <div class="skeleton" style="height:60px"></div>
      </div>
    </div>
  </main>

  <div id="toast-container"></div>
  <script src="/app.js"></script>

  <script>
    // ── Live Log WebSocket ──────────────────────────────────
    var MAX_LOG_LINES = 500;
    var logPanel = document.getElementById('log-panel');

    function clearLog() {
      logPanel.innerHTML = '<div class="log-panel__empty">Log cleared.</div>';
    }

    function appendLog(text, stream) {
      // Remove the empty placeholder if present
      var empty = logPanel.querySelector('.log-panel__empty');
      if (empty) empty.remove();

      var lines = text.split('\n');
      for (var i = 0; i < lines.length; i++) {
        if (!lines[i]) continue;
        var line = document.createElement('div');
        line.className = 'log-line' + (stream === 'stderr' ? ' log-line--stderr' : '');
        line.textContent = lines[i];
        logPanel.appendChild(line);
      }

      // Trim oldest lines
      while (logPanel.children.length > MAX_LOG_LINES) {
        logPanel.removeChild(logPanel.firstChild);
      }

      // Auto-scroll
      var autoScroll = document.getElementById('log-autoscroll');
      if (autoScroll && autoScroll.checked) {
        logPanel.scrollTop = logPanel.scrollHeight;
      }
    }

    // Connect WebSocket for log events (uses createWS from app.js)
    createWS(['orchestrator:log', 'orchestrator:started', 'orchestrator:stopped'], function(msg) {
      if (msg.event === 'orchestrator:log' && msg.data) {
        appendLog(msg.data.text, msg.data.stream);
      } else if (msg.event === 'orchestrator:started') {
        appendLog('--- Orchestrator started ---', 'stdout');
      } else if (msg.event === 'orchestrator:stopped') {
        appendLog('--- Orchestrator stopped ---', 'stdout');
      }
    });
  </script>
</body>
</html>
