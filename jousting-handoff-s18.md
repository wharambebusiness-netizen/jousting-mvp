# Jousting MVP — Session 18 Handoff (Multi-Agent Orchestrator)

## What Was Done

### Built a Multi-Agent Orchestrator System
Created `orchestrator/` directory with a complete autonomous agent management system that runs multiple Claude Code instances in parallel on different aspects of the Jousting MVP.

### Architecture Decisions & Why

**Problem**: Need multiple Claude agents working in parallel with:
- No permission prompts (unattended overnight runs)
- Fresh context each round (no conversation compression — user wants clear 60k handoffs)
- Coordination between agents (shared files, dependencies)
- Safety guardrails (circuit breakers, timeouts, git backups)

**Rejected approaches**:
- *Agent Teams* (experimental Claude feature) — requires tmux/WSL, no context rotation support
- *Git worktrees* — isolated but no coordination, merge conflicts on shared files (App.tsx, types.ts)
- *Single session with Task subagents* — no unattended operation, context still grows

**Chosen approach**: Custom Node.js orchestrator using `claude -p` (headless mode)
- Each round spawns fresh `claude -p` processes (zero context carryover)
- Handoff files bridge between rounds (agent writes what it did, next round reads it)
- Orchestrator owns task board generation + git commits (eliminates race conditions)
- Prompts piped via stdin (avoids Windows 8192-char command line limit)

## System Overview

### File Structure
```
jousting-mvp/
├── orchestrator/                 # Lives INSIDE the git repo
│   ├── orchestrator.mjs          # Main script (Node.js ESM, ~300 lines)
│   ├── run.bat                   # Windows launcher
│   ├── README.md                 # Full documentation
│   ├── task-board.md             # Auto-generated by orchestrator (agents READ ONLY)
│   ├── handoffs/
│   │   ├── ui-polish.md          # Caparison trigger icons + animations
│   │   ├── ai-engine.md          # STA%, speed-attack synergy, difficulty levels
│   │   ├── ai-reasoning.md       # AI Thinking panel (BLOCKED on ai-engine)
│   │   ├── balance-sim.md        # Continuous: simulate + analyze + tune balance
│   │   └── quality-review.md     # Continuous: test edge cases + review format
│   ├── analysis/                 # Balance reports + quality reports per round
│   └── logs/                     # Per-agent per-round logs + test results
├── src/                          # Game source code
└── jousting-handoff-s*.md        # Session handoffs
```

**Important**: orchestrator/ is inside jousting-mvp/ (the git repo). Agents run with CWD = jousting-mvp/, so paths like `orchestrator/handoffs/...` and `src/engine/...` both resolve correctly.

### 5 Agents

| Agent | Type | Task | Depends On | Files Owned |
|-------|------|------|------------|-------------|
| ui-polish | feature | Caparison trigger icons/emoji, animations, glow effects | none | helpers.tsx, PassResult.tsx, MeleeResult.tsx, App.css |
| ai-engine | feature | %-based STA thresholds, speed-attack synergy, AIDifficulty type, difficulty selector UI | none | basic-ai.ts, types.ts, balance-config.ts, SetupScreen.tsx |
| ai-reasoning | feature | AI Thinking panel showing decision weights, reasoning data exports | ai-engine | AIThinkingPanel.tsx (new), CombatLog.tsx |
| balance-sim | continuous | Run match simulations, analyze archetype win rates, tune balance-config.ts | ai-engine | balance-config.ts, archetypes.ts, simulate.ts (new) |
| quality-review | continuous | Review code quality, test edge cases, evaluate game format, add tests | none | *.test.ts files (add only) |

**Feature agents** mark themselves "complete" and stop. **Continuous agents** run every round.

### Round Flow
```
1. Orchestrator reads all handoff files, parses ## META sections
2. Generates task-board.md with agent statuses, dependencies, messages
3. Launches non-blocked agents in parallel via claude -p (stdin pipe)
4. Each agent: reads task board + handoff → does work → writes updated handoff
5. All agents finish (or timeout at 20 min)
6. Orchestrator runs full test suite (npx vitest run)
7. Git add -A && git commit (orchestrator-only, no agent commits)
8. Check circuit breaker (3 consecutive test failures → stop)
9. Check max runtime (6 hours → stop)
10. Repeat
```

### Key Design Decisions

**Orchestrator owns task board**: v1 had agents writing to the same task-board.md in parallel → race condition. v2 has the orchestrator generate it between rounds from handoff META sections.

**Orchestrator owns git**: v1 had agents running `git commit` in parallel → second commit captures first's half-finished work. v2 has only the orchestrator commit, once per round after all agents finish.

**Stdin pipe for prompts**: Windows cmd.exe has 8192-char limit. Agent prompts are short (~600 chars) and just say "read your handoff file." All detailed context lives in the handoff files that agents read with the Read tool.

**App.tsx coordination**: Multiple agents need to edit App.tsx. Rather than a lock mechanism, agents note their App.tsx changes in their handoff under "Deferred App.tsx Changes." The orchestrator (or a human/agent) integrates them.

**Handoff META format**: Structured header in every handoff file:
```markdown
## META
- status: complete | in-progress | blocked
- files-modified: file1.ts, file2.ts
- tests-passing: true | false
- notes-for-others: free text message for other agents
```
Orchestrator parses these with regex to determine agent state.

### Safety Guardrails

| Mechanism | Value | Purpose |
|-----------|-------|---------|
| Agent timeout | 20 min | Prevent hung agents |
| Max runtime | 6 hours | Prevent infinite runs |
| Circuit breaker | 3 consecutive test failures | Stop if things go wrong |
| Max rounds | 12 | Hard cap |
| Git backup/round | Every round | Easy revert to any point |
| Balance limits | ±5 per stat, 2 constants/round | Prevent wild balance swings |
| Quality agent | Add tests only, no engine edits | Prevent scope creep |
| No agent git | Orchestrator only | Prevent commit races |
| No agent task board edits | Auto-generated | Prevent race conditions |

### What Each Handoff Contains

Each agent's handoff file includes:
- META section (for orchestrator parsing)
- Mission statement
- Project context (paths, test command, reference files)
- Specific implementation instructions
- Files they own vs must not edit
- Key code locations with line numbers
- Safety rules specific to their role
- Previous work log (updated each round)

## Potential Issues / Review Points

### Things That Might Need Adjustment

1. **Agent prompts might need tuning**: The short prompt says "read your handoff file" — but the agent might not always follow through thoroughly. Could need more explicit instructions in the prompt itself vs relying on the handoff file.

2. **App.tsx integration gap**: No automated mechanism to merge deferred App.tsx changes from multiple agents. Currently relies on manual integration or a dedicated integration round. Consider adding an "integrator" agent or phase.

3. **Continuous agents may conflict with feature agents**: balance-sim edits balance-config.ts, but if ai-engine also touches it for difficulty levels, there could be overwrites. The dependency (balance-sim depends on ai-engine) mitigates this, but worth reviewing.

4. **balance-sim create-script pattern**: The balance-sim agent is told to create `src/tools/simulate.ts` if it doesn't exist. This is a lot of work for one round. Might be better to pre-create a skeleton.

5. **quality-review scope**: Can only ADD tests. But if it finds a real bug in the format/game design, it can only document it — no agent is assigned to fix format issues. Consider whether quality-review should have limited engine edit permission.

6. **--allowedTools granularity**: Currently allows all Bash commands. Could tighten to specific patterns (npm, npx, git status/log only) for more safety. But this might block agents from running their own scripts.

7. **No notification on completion**: When the orchestrator finishes at 3 AM, there's no alert. Could add a webhook, email, or system notification.

8. **Windows-specific**: `cmd /c` used for git backup. Process kill uses SIGTERM/SIGKILL which behave differently on Windows. May need `taskkill` instead.

9. **Agent model selection**: All agents use the default Claude model. Could pass `--model` to use different models for different roles (e.g., haiku for quality-review which mostly reads, opus for ai-engine which needs deep reasoning).

## Project State (unchanged from S17)

No engine, UI, or test changes were made this session. All changes are in the orchestrator/ directory and MEMORY.md.

- **222 tests passing** (unchanged)
- **Engine**: All formulas correct, all counter tables verified
- **UI**: 13 components, 10-screen state machine
- **AI**: 70/30 optimal/random, archetype-weighted decisions
- **Gear**: 3 stat slots + caparison, 6 rarity tiers
- **Deployed**: gh-pages via `npm run deploy`

## How to Run

```bash
# From jousting-mvp/
cd C:\Users\rvecc\Documents\Jousting\Jousting\jousting-mvp
node orchestrator\orchestrator.mjs
```

## How to Review

Start a new Claude session in the project directory and say:

> Read jousting-mvp/jousting-handoff-s18.md for the full context on what was built. Then read jousting-mvp/orchestrator/README.md and jousting-mvp/orchestrator/orchestrator.mjs. Then read all 5 handoff files in jousting-mvp/orchestrator/handoffs/. Review the system for issues, suggest improvements, and help me decide if it's ready to run.

## Files Created/Modified This Session

### Created
- `orchestrator/orchestrator.mjs` — Main orchestrator script (v2)
- `orchestrator/run.bat` — Windows launcher
- `orchestrator/README.md` — Documentation
- `orchestrator/task-board.md` — Initial task board (will be auto-generated)
- `orchestrator/handoffs/ui-polish.md` — UI polish agent handoff
- `orchestrator/handoffs/ai-engine.md` — AI engine agent handoff
- `orchestrator/handoffs/ai-reasoning.md` — AI reasoning agent handoff
- `orchestrator/handoffs/balance-sim.md` — Balance simulation agent handoff
- `orchestrator/handoffs/quality-review.md` — Quality review agent handoff
- `jousting-mvp/jousting-handoff-s18.md` — This file

### Modified
- `.claude/projects/.../memory/MEMORY.md` — Added orchestrator section, updated TODO
